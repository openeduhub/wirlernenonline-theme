(()=>{"use strict";var e,t={271:()=>{const e=window.wp.blocks,t=window.wp.element,l=window.wp.blockEditor,n=window.wp.components;function r({headingText:e,setHeadingText:l}){return(0,t.createElement)("div",{className:"heading-input"},(0,t.createElement)(n.TextControl,{label:"Überschrift",value:e,onChange:l}))}const a=JSON.parse('[{"key":"educationalContext","label":"Bildungsstufe","educationalFilterValuesKey":"educationalContexts","eduSharingPropertyKey":"ccm:educationalcontext","vocabsUrl":"http://w3id.org/openeduhub/vocabs/educationalContext/","options":[{"value":"grundschule","label":"Primarstufe"},{"value":"sekundarstufe_1","label":"Sekundarstufe I"},{"value":"sekundarstufe_2","label":"Sekundarstufe II"}]},{"key":"intendedEndUserRole","label":"Zielgruppe","educationalFilterValuesKey":"intendedEndUserRoles","eduSharingPropertyKey":"ccm:educationalintendedenduserrole","vocabsUrl":"http://w3id.org/openeduhub/vocabs/intendedEndUserRole/","options":[{"value":"learner","label":"Lerner/in"},{"value":"teacher","label":"Lehrer/in"}]},{"key":"oer","label":"OER","educationalFilterValuesKey":"oer","options":[{"value":"oer","label":"OER"},{"value":"no-oer","label":"Kein OER"}]},{"key":"native-language","label":"Muttersprache","options":[{"value":"english","label":"English"},{"value":"french","label":"Français"},{"value":"turkish","label":"Türkçe"}]},{"key":"profession","label":"Beruf","options":[{"value":"catering","label":"Gastronomie"},{"value":"cleaner","label":"Reinigungsfachkraft"},{"value":"gardener","label":"Gärtner/in"}]}]'),o=new class{_collectionId;_collectionData;_collectionsHierarchy;getCurrentCollectionId(){const e=("collection_url",acf.getFields({name:"collection_url"}).map((e=>e.val())).find((e=>!!e)));if(e)try{return function(e){const t=new URL(e).search;return new URLSearchParams(t).get("id")}(e)}catch(e){return null}return null}getCollectionData(e){var t;return this._updateCollectionId(e),null!==(t=this._collectionData)&&void 0!==t||(this._collectionData=this._fetchCollectionData(e)),this._collectionData}getCollectionHierarchy(e){var t;return this._updateCollectionId(e),null!==(t=this._collectionsHierarchy)&&void 0!==t||(this._collectionsHierarchy=this._fetchCollectionHierarchy(e)),this._collectionsHierarchy}async _updateCollectionId(e){e&&e===this._collectionId||(this._collectionId=e,this._collectionData=null,this._collectionsHierarchy=null)}async _fetchCollectionData(e){const t=await fetch(window.chatGptPromptConfig.eduSharingUrl+"rest/collection/v1/collections/-home-/"+e);if(t.ok)return(await t.json()).collection;throw new Error(`Failed to fetch collection data for id ${e}`)}async _fetchCollectionHierarchy(e){const t=await fetch(window.chatGptPromptConfig.eduSharingUrl+"rest/node/v1/nodes/-home-/"+e+"/parents");if(t.ok)return(await t.json()).nodes.reverse();throw new Error(`Failed to fetch collection hierarchy for id ${e}`)}},i=JSON.parse('[{"label":"Titel","property":"cm:title"},{"label":"Hierarchie","computeKey":"hierarchy","multiple":true},{"label":"Beschreibung","property":"cm:description"},{"label":"Schlagwort","multipleLabel":"Schlagwörter","property":"cclom:general_keyword","multiple":true},{"label":"Wordpress-Link","property":"cclom:location"},{"label":"Sammlungs-Link","computeKey":"collectionUrl"},{"label":"Kurzer Titel","property":"ccm:collectionshorttitle"},{"label":"Sammlungstyp","property":"ccm:collectiontype"},{"label":"Zuletzt geändert","property":"cm:modifiedISO8601"},{"label":"Fach","multipleLabel":"Fächer","property":"ccm:taxonid_DISPLAYNAME","multiple":true},{"label":"Aufrufe","property":"ccm:tracking_views"},{"label":"Erstellt","property":"cm:createdISO8601"},{"label":"Ersteller*in","property":"cm:creator"},{"label":"Eigentümer*in","property":"cm:owner"},{"label":"Version","property":"cm:versionLabel"},{"label":"UUID","property":"sys:node-uuid"}]'),s=new class{getEnabledVariables(e){return a.filter((({label:t})=>e.includes(this.getPlaceholderKey(t))))}replaceVariablePlaceholders(e,t){const l=this.getEnabledVariables(e).map((({key:e})=>this._getKeyValueLabels(e,t[e])));return this._replacePlaceholders(e,l)}getPlaceholderKey(e){return"$"+(e=(e=e.replace(/[\s-\*]/,"_")).toUpperCase())+"$"}async replaceCollectionPlaceholders(e,t){try{const l=await this.getCollectionPlaceholders(t);return this._replacePlaceholders(e,l)}catch(t){return e}}async getCollectionPlaceholders(e){const t=await o.getCollectionData(e),l=await o.getCollectionHierarchy(e);let n=[];for(const e of i){const r=this._getCollectionPlaceholderValues(e,t,l);n=[...n,...r]}return n}_replacePlaceholders(e,t){let l=e;for(const[e,n]of t)l=l.replace(this.getPlaceholderKey(e),n);return l}_getKeyValueLabels(e,t){const l=a.find((t=>t.key===e)),n=l.options.find((e=>e.value===t));return[l.label,n.label]}_getCollectionPlaceholderValues(e,t,l){let n;var r;return e.property?n=t.properties[e.property]:e.computeKey&&(n=this._getComputedPlaceholderValues(e,t,l)),n?.[0]?.trim()?e.multiple?[[null!==(r=e.multipleLabel)&&void 0!==r?r:e.label,n.join(", ")],...n.map(((t,l)=>[`${e.label}_${l}`,t]))]:[[e.label,n[0]]]:[]}_getComputedPlaceholderValues(e,t,l){switch(e.computeKey){case"collectionUrl":return[window.chatGptPromptConfig.eduSharingUrl+"components/collections?id="+t.ref.id];case"hierarchy":const[e,...n]=l;return n.map((e=>e.title));default:return[]}}};function c({collectionId:e,updateCollectionId:l}){const[r,a]=(0,t.useState)(),[o,i]=(0,t.useState)(),[c,u]=(0,t.useState)();return(0,t.useEffect)((()=>{if(u(null),!e)return i(null),void a(null);i("loading"),s.getCollectionPlaceholders(e).then((e=>{i("success"),a(e)})).catch((e=>{console.error(e),u(e),i("error")}))}),[e]),(0,t.createElement)("div",{className:"collection-placeholders"},function(){var e;switch(o){case"loading":return(0,t.createElement)(n.Spinner,{className:"collection-placeholders-spinner"});case"success":return(0,t.createElement)("table",{className:"placeholders-table"},r.map((([e,l])=>(0,t.createElement)("tr",null,(0,t.createElement)("td",null,(0,t.createElement)("code",null,s.getPlaceholderKey(e))),(0,t.createElement)("td",null,l)))));case"error":return c&&(0,t.createElement)(n.Notice,{status:"error",onRemove:()=>u(null)},(0,t.createElement)("p",null,null!==(e=c.toString())&&void 0!==e?e:"Error loading collection data"))}}(),(0,t.createElement)(n.Button,{variant:"link",onClick:l,disabled:"loading"===o},"Aktualisiere Sammlungswerte"))}const u=a.map((e=>e.label));function d({collectionId:e,updateCollectionId:l}){return(0,t.createElement)("div",{className:"prompt-heading"},(0,t.createElement)("h3",null,"Anfrage"),(0,t.createElement)("p",null,"Formulieren Sie eine Anfrage an ChatGPT."),(0,t.createElement)("p",null,"Die Platzhalter"," ",u.map(((e,l)=>(0,t.createElement)(t.Fragment,null,(0,t.createElement)("code",null,"$",e.toLocaleUpperCase(),"$"),l<u.length-1?", ":" "))),"werden automatisch durch die jeweils auf der Seite eingestellten Werte ersetzt."),(0,t.createElement)(n.Panel,null,(0,t.createElement)(n.PanelBody,{title:"Platzhalter aus Sammlungswerten",initialOpen:!1,onToggle:l},(0,t.createElement)(n.PanelRow,null,e?(0,t.createElement)(c,{collectionId:e,updateCollectionId:l}):(0,t.createElement)("p",null,"Geben Sie eine Sammlungs-URL an, um weitere Platzhalter zu nutzen.")))))}function p({promptText:e,setPromptText:l,sendChatGptRequests:r,isLoading:a}){const[o,i]=(0,t.useState)(e);return(0,t.createElement)("div",{className:"prompt-textarea"},(0,t.createElement)(n.TextareaControl,{className:"textarea",label:"Prompt für ChatGPT",help:(0,t.createElement)(t.Fragment,null,(0,t.createElement)("p",null,'Wenn Sie "Senden" klicken, werden die Antworten von ChatGPT eingeholt und überschreiben die vorigen Antworten inklusive aller eigener Anpassungen.')),value:o,onChange:i}),(0,t.createElement)(n.Button,{className:"send-button",variant:"primary",onClick:function(){l(o),r(o)},disabled:a},a?(0,t.createElement)(n.Spinner,null):"Senden"))}function h({}){return(0,t.createElement)("div",{className:"response-heading"},(0,t.createElement)("h3",null,"Antworten"),(0,t.createElement)("p",null,"Hier haben Sie die Möglichkeit, die Anworten von ChatGPT zu prüfen und selbst Anpassungen vorzunehmen. Nutzen Sie die Auswahlboxen um die Antworten für verschiedenen Werte zu sehen, die auf der Seite eingestellt werden können."))}function m(e,t){return Object.keys(e).filter((e=>t.some((t=>t.key===e)))).sort().map((t=>`${t}:${e[t]}`)).join("|")}function b({selectValues:e,originalResponseTexts:l,responseTexts:r,setResponseTexts:a,promptText:o,isLoading:i}){var c;const u=s.replaceVariablePlaceholders(o,e);let d="Die Antwort von ChatGPT";u&&(d+=` für die Anfrage "${u}"`);const p=s.getEnabledVariables(o);return(0,t.createElement)("div",{className:"prompt-textarea"},(0,t.createElement)(n.TextareaControl,{className:"textarea",label:d,help:"Sie können die Antwort selbst anpassen.",value:null!==(c=r[m(e,p)]?.text)&&void 0!==c?c:"",rows:r[m(e,p)]?.text?10:4,onChange:function(t){const n=m(e,p),o=l[n].text!==t.trim();a({...r,[n]:{text:t,changed:o,editedBy:r[n]?.editedBy}})},disabled:i}))}function g({selectValues:e,setSelectValues:l,isLoading:r,variables:a}){const o=a.map((a=>(0,t.createElement)(n.SelectControl,{label:a.label,value:e[a.key],options:a.options,onChange:t=>l({...e,[a.key]:t}),disabled:r})));return(0,t.createElement)("div",{className:"variable-selector"},o)}function f(e){const t=[],l=v(s.getEnabledVariables(e));for(const n of l){const l=s.replaceVariablePlaceholders(e,n);t.push(y(l).then((e=>({combination:n,response:e}))))}return Promise.all(t)}function v(e){if(0===e.length)return[{}];const[t,...l]=e,n=v(l);return t.options.flatMap((e=>n.map((l=>({...l,[t.key]:e.value})))))}async function y(e){const t=await fetch(ajaxurl,{method:"post",body:E({action:"wloChatGptPrompt",prompt:e})});if(t.ok)return(await t.json()).responses[0];throw console.error(t),new Error("Fehler bei Chat-GPT-Anfrage: "+t.status)}function E(e){const t=new FormData;for(const[l,n]of Object.entries(e))t.append(l,n);return t}const w=a.reduce(((e,t)=>(e[t.key]=t.options[0].value,e)),{}),C=JSON.parse('{"u2":"wirlernenonline-theme/chat-gpt-prompt"}');(0,e.registerBlockType)(C.u2,{edit:function({attributes:e,setAttributes:a,clientId:i}){var c,u,v,y;const[E,C]=(0,t.useState)(e.headingText||"Chat GPT"),[x,S]=(0,t.useState)(e.enabledVariables||[]),[k,P]=(0,t.useState)(null!==(c=e.promptText)&&void 0!==c?c:""),[T,_]=(0,t.useState)(null!==(u=e.promptTextWithCollectionValues)&&void 0!==u?u:""),[V,O]=(0,t.useState)(null!==(v=e.responseTexts)&&void 0!==v?v:{}),[I,N]=(0,t.useState)(V),[L,A]=(0,t.useState)(w),[R,U]=(0,t.useState)(!1),[G,K]=(0,t.useState)(),[j,F]=(0,t.useState)(o.getCurrentCollectionId());return(0,t.useEffect)((()=>{a({headingText:E,enabledVariables:x,promptText:k,promptTextWithCollectionValues:T,responseTexts:I})}),[E,x,k,T,I]),(0,t.useEffect)((()=>{e.id||a({id:i})})),(0,t.useEffect)((()=>{S(s.getEnabledVariables(k))}),[k]),(0,t.createElement)("div",{...(0,l.useBlockProps)()},G&&(0,t.createElement)(n.Notice,{status:"error",onRemove:()=>K(null)},(0,t.createElement)("p",null,null!==(y=G.toString())&&void 0!==y?y:"Fehler beim Senden der Anfrage")),(0,t.createElement)(r,{headingText:E,setHeadingText:C}),(0,t.createElement)(d,{collectionId:j,updateCollectionId:function(){const e=o.getCurrentCollectionId();e!==j&&F(e)}}),(0,t.createElement)(p,{promptText:k,setPromptText:P,sendChatGptRequests:async function(e){K(null),U(!0);try{const t=await s.replaceCollectionPlaceholders(e,j),l=await f(t),n=s.getEnabledVariables(e),r=l.reduce(((e,t)=>(e[m(t.combination,n)]={text:t.response.trim()},e)),{});O(r),N(r),_(t)}catch(e){console.error(e),K(e)}U(!1)},isLoading:R}),(0,t.createElement)(h,null),(0,t.createElement)(g,{selectValues:L,setSelectValues:A,isLoading:R,variables:x}),(0,t.createElement)(b,{selectValues:L,originalResponseTexts:V,responseTexts:I,setResponseTexts:N,promptText:T,isLoading:R}))},save:function({attributes:e}){const n=wp.data.select("core").getCurrentUser();return"string"==typeof e.responseTexts?e.responseTexts=JSON.parse(e.responseTexts):"object"==typeof e.responseTexts&&(e.responseTexts=function(e){const t={};for(const[r,a]of Object.entries(e)){let{text:e,changed:o,editedBy:i}=a;var l;o&&!i?.includes(n.name)&&(i=[...null!==(l=i)&&void 0!==l?l:[],n.name]),t[r]={text:e?.trim(),editedBy:i}}return t}(e.responseTexts)),"string"==typeof e.enabledVariables&&(e.enabledVariables=JSON.parse(e.enabledVariables)),(0,t.createElement)("div",{...l.useBlockProps.save(),id:e.id,"data-response-texts":JSON.stringify(e.responseTexts),"data-enabled-variables":JSON.stringify(e.enabledVariables)},(0,t.createElement)("h2",null,e.headingText),(0,t.createElement)("div",{className:"response-text"}),(0,t.createElement)("p",{className:"edited-by"}),(0,t.createElement)("script",null,`jQuery(document).ready(() => registerChatGptBlock('${e.id}'))`))}})}},l={};function n(e){var r=l[e];if(void 0!==r)return r.exports;var a=l[e]={exports:{}};return t[e](a,a.exports,n),a.exports}n.m=t,e=[],n.O=(t,l,r,a)=>{if(!l){var o=1/0;for(u=0;u<e.length;u++){l=e[u][0],r=e[u][1],a=e[u][2];for(var i=!0,s=0;s<l.length;s++)(!1&a||o>=a)&&Object.keys(n.O).every((e=>n.O[e](l[s])))?l.splice(s--,1):(i=!1,a<o&&(o=a));if(i){e.splice(u--,1);var c=r();void 0!==c&&(t=c)}}return t}a=a||0;for(var u=e.length;u>0&&e[u-1][2]>a;u--)e[u]=e[u-1];e[u]=[l,r,a]},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{var e={324:0,778:0};n.O.j=t=>0===e[t];var t=(t,l)=>{var r,a,o=l[0],i=l[1],s=l[2],c=0;if(o.some((t=>0!==e[t]))){for(r in i)n.o(i,r)&&(n.m[r]=i[r]);if(s)var u=s(n)}for(t&&t(l);c<o.length;c++)a=o[c],n.o(e,a)&&e[a]&&e[a][0](),e[a]=0;return n.O(u)},l=self.webpackChunkblocks=self.webpackChunkblocks||[];l.forEach(t.bind(null,0)),l.push=t.bind(null,l.push.bind(l))})();var r=n.O(void 0,[778],(()=>n(271)));r=n.O(r)})();